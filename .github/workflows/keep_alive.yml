name: 保活：hyde-platform

on:
  schedule:
    - cron: '*/30 * * * *'  # 每15分钟运行一次
  workflow_dispatch:        # 允许手动运行

jobs:
  ping:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Check HF Space status
        run: |
          # 从 Environment Variables 读取
          HF_SPACE_URL="${{ vars.HF_SPACE_URL }}"
          
          if [ -z "$HF_SPACE_URL" ]; then
            echo "Error: HF_SPACE_URL variable is not set in 'production' environment."
            echo "Please go to Settings -> Environments -> production -> Environment variables and add HF_SPACE_URL."
            exit 1
          fi

          # 移除 URL 末尾可能的斜杠
          BASE_URL="$HF_SPACE_URL"
          BASE_URL=${BASE_URL%/}
          
          TARGET_URL="$BASE_URL/api/health"
          echo "Pinging $TARGET_URL..."

          # 添加 User-Agent 伪装，添加 -L 跟随重定向，添加 -S 显示错误
          response=$(curl -s -S -L -o /dev/null -w "%{http_code}" \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            "$TARGET_URL")
          
          if [ "$response" -eq 200 ]; then
            echo "Success! Status code: $response"
          else
            echo "Warning: Received status code $response"
          fi
